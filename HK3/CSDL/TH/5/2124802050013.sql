CREATE DATABASE THBUOI5
USE THBUOI5

--CAU1:

CREATE TABLE CUSTOMER(
	cID INT NOT NULL PRIMARY KEY,
	cNAME VARCHAR(25),
	cAGE TINYINT)

CREATE TABLE ODER(
	oID int NOT NULL PRIMARY KEY,
	cID int,
	oDATE Date,
	oTOTALPRICE int)

CREATE TABLE PRODUCT(
	pID int NOT NULL PRIMARY KEY,
	pNAME varchar(25),
	pPRICE int)

CREATE TABLE ORDERDETAIL(
	oID int NOT NULL,
	pID int NOT NULL,
	odQTY int,
	CONSTRAINT PK_oID_pID PRIMARY KEY(oID, pID))

ALTER TABLE ODER ADD
	CONSTRAINT FK_cID_cID FOREIGN KEY (cID) REFERENCES CUSTOMER(cID)

ALTER TABLE ORDERDETAIL ADD
	CONSTRAINT FK_oID_oID FOREIGN KEY(oID) REFERENCES ODER(oID),
	CONSTRAINT FK_pID_pID FOREIGN KEY(pID) REFERENCES PRODUCT(pID)

--CAU 2:
ALTER TABLE CUSTOMER ADD
	CMND VARCHAR(9) UNIQUE
ALTER TABLE PRODUCT ADD
	pQTY INT DEFAULT(100)

--CAU 3:

INSERT INTO CUSTOMER(cID, cNAME, cAGE, CMND) VALUES
(1, 'Minh Quan', 40, 123456789),
(2, 'Ngoc Oanh', 20, 987654321),
(3, 'Hong Ha', 50, 123456798),
(4, 'Minh Anh', 35, 897654321),
(5, 'Ha Tran', 32, 123456879),
(6, 'Tran Minh', 41, 978654321)

INSERT INTO ODER(oID, cID, oDATE, oTOTALPRICE) VALUES
(1, 1, '3/21/2020',''),
(2, 2, '3/23/2020',''),
(3, 1, '3/16/2020',''),
(4, 3, '3/10/2020',''),
(5, 4, '3/01/2020','')

INSERT INTO PRODUCT(pID, pNAME, pPRICE) VALUES
(1, 'May Giat', 5),
(2, 'Tu Lanh', 5),
(3, 'Dieu Hoa', 10),
(4, 'Quat', 2),
(5, 'Bep Dien', 3),
(6, 'May Hut Bui', 4),
(7, 'Bong Den', 1)

INSERT INTO ORDERDETAIL(oID, pID, odQTY) VALUES
(1, 1, 4),
(1, 3, 6),
(1, 4, 4),
(2, 1, 3),
(3, 1, 8),
(2, 5, 4),
(2, 3, 3),
(4, 5, 4),
(5, 4, 5)

--CAU 4:
--a)
SELECT OD.oID, cID, oDATE, oTOTALPRICE=PR.pPRICE*ORD.odQTY
FROM ODER OD, PRODUCT PR, ORDERDETAIL ORD
WHERE ORD.oID = OD.oID AND ORD.pID = PR.pID
ORDER BY oDATE DESC 

--b)
SELECT pNAME, pPRICE
FROM PRODUCT
WHERE pPRICE = (SELECT MAX(pPRICE) FROM PRODUCT)

--c)
SELECT CS.cID, cNAME
FROM CUSTOMER CS, ODER OD, PRODUCT PR, ORDERDETAIL ORD
WHERE CS.cID = OD.cID AND OD.oID = ORD.oID AND ORD.pID = PR.pID
GROUP BY CS.cID, cNAME
HAVING SUM(odQTY) >= ALL (SELECT SUM(odQTY) AS 'SOLUONG'
FROM CUSTOMER CS, ODER OD, PRODUCT PR, ORDERDETAIL ORD
WHERE CS.cID = OD.cID AND OD.oID = ORD.oID AND ORD.pID = PR.pID
GROUP BY CS.cID)

--d)
SELECT pNAME, pPRICE
FROM PRODUCT
WHERE pPRICE = (SELECT MIN(pPRICE) FROM PRODUCT)

--e)
SELECT PR.pID, pNAME, pPRICE
FROM ORDERDETAIL ORD, PRODUCT PR
WHERE ORD.pID = PR.pID
GROUP BY PR.pID, pNAME, pPRICE
HAVING SUM(odQTY) >= ALL (SELECT SUM(odQTY) AS 'SO LUONG'
FROM ORDERDETAIL ORD, PRODUCT PR
WHERE ORD.pID = PR.pID
GROUP BY PR.pID)

--f)
SELECT CS.cID, cNAME, SUM(odQTY) AS 'SOLUONG'
FROM CUSTOMER CS, ODER OD, PRODUCT PR, ORDERDETAIL ORD
WHERE CS.cID = OD.cID AND OD.oID = ORD.oID AND ORD.pID = PR.pID
GROUP BY CS.cID, cNAME
HAVING SUM(odQTY) <= ALL (SELECT SUM(odQTY) AS 'SOLUONG'
FROM CUSTOMER CS, ODER OD, PRODUCT PR, ORDERDETAIL ORD
WHERE CS.cID = OD.cID AND OD.oID = ORD.oID AND ORD.pID = PR.pID
GROUP BY CS.cID)

--g)
SELECT CS.cID, cNAME
FROM CUSTOMER CS
where CS.cID NOT IN (SELECT cID FROM ODER)
GROUP BY CS.cID, cNAME
--HAVING CS.cID NOT IN (SELECT cID FROM ODER)

--Cau 5:
--a)
CREATE VIEW SALES2 AS 
SELECT PR.pID, SUM(odQTY * pPRICE) AS 'DOANH THU'
FROM ODER OD, ORDERDETAIL ORD, PRODUCT PR
WHERE PR.pID = ORD.pID AND OD.oID = ORD.oID
GROUP BY PR.pID

--b)
CREATE VIEW CUSNOBUY AS
SELECT cNAME
FROM CUSTOMER CS
GROUP BY CS.cID, cNAME
HAVING CS.cID NOT IN (SELECT cID FROM ODER)

CREATE VIEW SPCHUAMUA AS
SELECT PR.pID, pNAME, pPRICE
FROM PRODUCT PR, ORDERDETAIL ORD
GROUP BY PR.pID, pNAME, pPRICE
HAVING PR.pID NOT IN (SELECT pID FROM ORDERDETAIL)